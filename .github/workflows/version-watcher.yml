name: Version Watcher

on:
  push:
    branches:
      - main
    paths:
      - "version.json"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      qa-changes: ${{ steps.check-qa.outputs.changes }}
      uat-changes: ${{ steps.check-uat.outputs.changes }}
      prod-changes: ${{ steps.check-prod.outputs.changes }}
      qa-services: ${{ steps.check-qa.outputs.services }}
      uat-services: ${{ steps.check-uat.outputs.services }}
      prod-services: ${{ steps.check-prod.outputs.services }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check for QA changes
        id: check-qa
        run: |
          CHANGES=$(git diff HEAD^ HEAD -- version.json | grep -E '"qa": "' || echo "")
          if [ -n "$CHANGES" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            SERVICES=$(echo "$CHANGES" | grep -oE '"[^"]+": {' | sed 's/": {//' | sed 's/"//g' | tr '\n' ',' | sed 's/,$//')
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "services=" >> $GITHUB_OUTPUT
          fi

      - name: Check for UAT changes
        id: check-uat
        run: |
          CHANGES=$(git diff HEAD^ HEAD -- version.json | grep -E '"uat": "' || echo "")
          if [ -n "$CHANGES" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            SERVICES=$(echo "$CHANGES" | grep -oE '"[^"]+": {' | sed 's/": {//' | sed 's/"//g' | tr '\n' ',' | sed 's/,$//')
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "services=" >> $GITHUB_OUTPUT
          fi

      - name: Check for Production changes
        id: check-prod
        run: |
          CHANGES=$(git diff HEAD^ HEAD -- version.json | grep -E '"prod": "' || echo "")
          if [ -n "$CHANGES" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            SERVICES=$(echo "$CHANGES" | grep -oE '"[^"]+": {' | sed 's/": {//' | sed 's/"//g' | tr '\n' ',' | sed 's/,$//')
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "services=" >> $GITHUB_OUTPUT
          fi

  deploy-qa:
    needs: detect-changes
    if: needs.detect-changes.outputs.qa-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ecommerce-infra repo
        uses: actions/checkout@v4
        with:
          path: ecommerce-infra
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Deploy to QA server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.QA_SERVER_HOST }}
          username: ${{ secrets.QA_SERVER_USER }}
          key: ${{ secrets.QA_SERVER_SSH_KEY }}
          port: 22
          script: |
            cd ecommerce-infra
            git pull origin main
            ./run-qa-environment-ec2.sh

  deploy-uat:
    needs: detect-changes
    if: needs.detect-changes.outputs.uat-changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

  deploy-prod:
    needs: detect-changes
    if: needs.detect-changes.outputs.prod-changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
